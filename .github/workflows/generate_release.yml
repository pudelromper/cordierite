on:
  workflow_call:
  workflow_dispatch:
    inputs:
      notes:
        description: 'Release notes (optional)'
permissions:
  contents: write

name: Generate Release
jobs:
  generate-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Get target
        id: get-target
        run: |
          TARGET="${{ github.event.inputs.target || github.ref }}"
          TARGET="${TARGET##*/}"
          if [ "$TARGET" = "main" ]; then
            TARGET="stable"
          fi
          echo "target=$TARGET" >> $GITHUB_OUTPUT

      - name: Generate Release Info
        id: generate-release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the latest release number, default to 0 if none exists
          LATEST=$(gh release list --limit 1 --json tagName -q '.[0].tagName' 2>/dev/null || echo "")

          if [[ -z "$LATEST" || "$LATEST" == "null" ]]; then
            NEXT=1
          else
            # Extract number from tag (e.g., "v5" -> 5, "release-5" -> 5, "5" -> 5)
            CURRENT=$(echo "$LATEST" | grep -oE '[0-9]+' | tail -1)
            NEXT=$((CURRENT + 1))
          fi

          TAG="v${NEXT}"
          TITLE="Cordierite Release ${NEXT}"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "title=${TITLE}" >> $GITHUB_OUTPUT
          echo "number=${NEXT}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          name: ${{ steps.generate-release.outputs.title }}
          tag_name: ${{ steps.generate-release.outputs.tag }}
          body: |
            ## Cordierite Release ${{ steps.generate-release.outputs.number }}

            ${{ github.event.inputs.notes || 'Automated release from CI build.' }}

            ### Download ISOs
            ISOs will be uploaded to Backblaze B2 after the build completes.
          make_latest: ${{ steps.get-target.outputs.target == 'stable' }}
          prerelease: ${{ steps.get-target.outputs.target != 'stable' }}
